#!/usr/bin/env node

/**
 * Node-forge Vulnerability Checker
 * 
 * This script checks if node-forge is present in the dependency tree
 * and validates that only safe versions (>= 1.3.1) are used.
 * 
 * Exit codes:
 * 0 - No issues found
 * 1 - Vulnerable version of node-forge detected
 * 2 - Script execution error
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Configuration
const CONFIG = {
  searchPatterns: ['node-forge', "from 'forge'", "require.*forge"],
  excludedDirs: ['node_modules', '__tests__/security', 'scripts'],
  fileExtensions: ['.ts', '.tsx', '.js', '.jsx'],
};

// ANSI color codes for terminal output
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
};

function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

function logSuccess(message) {
  log(`âœ… ${message}`, colors.green);
}

function logError(message) {
  log(`âŒ ${message}`, colors.red);
}

function logWarning(message) {
  log(`âš ï¸  ${message}`, colors.yellow);
}

function logInfo(message) {
  log(`â„¹ï¸  ${message}`, colors.cyan);
}

function checkNodeForgeInDependencies() {
  logInfo('Checking for node-forge in package.json dependencies...');
  
  const packageJsonPath = path.join(process.cwd(), 'package.json');
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
  
  const allDeps = {
    ...packageJson.dependencies,
    ...packageJson.devDependencies,
  };
  
  if (allDeps['node-forge']) {
    logError('node-forge found in package.json dependencies!');
    logWarning(`Version: ${allDeps['node-forge']}`);
    return false;
  }
  
  logSuccess('No node-forge in direct dependencies');
  return true;
}

function checkNodeForgeInTree() {
  logInfo('Checking for node-forge in dependency tree...');
  
  try {
    const output = execSync('npm ls node-forge --all 2>&1', {
      encoding: 'utf-8',
      cwd: process.cwd(),
    });
    
    if (output.includes('(empty)')) {
      logSuccess('No node-forge in dependency tree');
      return true;
    }
    
    // Parse the output to check version
    const versionMatch = output.match(/node-forge@([\d.]+)/);
    if (versionMatch) {
      const version = versionMatch[1];
      const [major, minor, patch] = version.split('.').map(Number);
      
      // Check if version is >= 1.3.1
      if (major > 1 || (major === 1 && minor > 3) || (major === 1 && minor === 3 && patch >= 1)) {
        logSuccess(`node-forge@${version} is a safe version (>= 1.3.1)`);
        return true;
      } else {
        logError(`Vulnerable node-forge@${version} detected! (< 1.3.1)`);
        logError('This version is affected by CVE-2024-48939');
        return false;
      }
    }
    
    logWarning('node-forge detected but version could not be determined');
    console.log(output);
    return false;
  } catch (error) {
    // Exit code 1 usually means not found
    if (error.status === 1 && error.stdout.includes('(empty)')) {
      logSuccess('No node-forge in dependency tree');
      return true;
    }
    
    logWarning('Error checking dependency tree');
    console.error(error.message);
    return true; // Don't fail on check error
  }
}

function checkPackageLock() {
  logInfo('Checking package-lock.json for node-forge...');
  
  const packageLockPath = path.join(process.cwd(), 'package-lock.json');
  
  if (!fs.existsSync(packageLockPath)) {
    logWarning('package-lock.json not found');
    return true;
  }
  
  const packageLockContent = fs.readFileSync(packageLockPath, 'utf-8');
  
  if (packageLockContent.includes('"node-forge"')) {
    logWarning('node-forge entries found in package-lock.json');
    
    // Try to extract version information
    const versionMatches = packageLockContent.match(/"node-forge".*?"version":\s*"([\d.]+)"/g);
    if (versionMatches) {
      versionMatches.forEach(match => {
        console.log(`  Found: ${match}`);
      });
    }
    
    return false;
  }
  
  logSuccess('No node-forge entries in package-lock.json');
  return true;
}

function checkOverrides() {
  logInfo('Checking package.json overrides...');
  
  const packageJsonPath = path.join(process.cwd(), 'package.json');
  const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));
  
  if (packageJson.overrides && packageJson.overrides['node-forge']) {
    logSuccess(`Override configured: node-forge ${packageJson.overrides['node-forge']}`);
    return true;
  }
  
  logWarning('No override configured for node-forge in package.json');
  logInfo('Consider adding: "overrides": { "node-forge": ">=1.3.1" }');
  return true; // Warning only, not an error
}

function checkNpmrc() {
  logInfo('Checking .npmrc configuration...');
  
  const npmrcPath = path.join(process.cwd(), '.npmrc');
  
  if (!fs.existsSync(npmrcPath)) {
    logWarning('.npmrc not found');
    return true;
  }
  
  const npmrcContent = fs.readFileSync(npmrcPath, 'utf-8');
  
  if (npmrcContent.includes('audit=true')) {
    logSuccess('.npmrc has audit enabled');
    return true;
  }
  
  logWarning('audit not enabled in .npmrc');
  return true;
}

function scanCodebase() {
  logInfo('Scanning codebase for node-forge imports...');
  
  try {
    // Build grep pattern from config
    const grepPattern = CONFIG.searchPatterns.join('\\|');
    const includePatterns = CONFIG.fileExtensions.map(ext => `--include="*${ext}"`).join(' ');
    
    const output = execSync(
      `grep -r "${grepPattern}" . ${includePatterns} 2>/dev/null || true`,
      { encoding: 'utf-8', cwd: process.cwd() }
    );
    
    // Filter out excluded directories
    const relevantLines = output
      .split('\n')
      .filter(line => {
        if (!line) return false;
        return !CONFIG.excludedDirs.some(dir => line.includes(dir));
      });
    
    if (relevantLines.length > 0) {
      logError('node-forge imports found in codebase:');
      relevantLines.forEach(line => console.log(`  ${line}`));
      return false;
    }
    
    logSuccess('No node-forge imports found in codebase');
    return true;
  } catch (error) {
    logWarning('Error scanning codebase');
    return true;
  }
}

function main() {
  console.log('\n' + '='.repeat(60));
  log('ðŸ”’ Node-forge Vulnerability Checker', colors.magenta);
  log('Checking for CVE-2024-48939 (ASN.1 Validator Vulnerability)', colors.blue);
  console.log('='.repeat(60) + '\n');
  
  const results = [
    checkNodeForgeInDependencies(),
    checkNodeForgeInTree(),
    checkPackageLock(),
    checkOverrides(),
    checkNpmrc(),
    scanCodebase(),
  ];
  
  console.log('\n' + '='.repeat(60));
  
  const allPassed = results.every(result => result);
  
  if (allPassed) {
    logSuccess('All checks passed! No node-forge vulnerabilities detected.');
    console.log('='.repeat(60) + '\n');
    process.exit(0);
  } else {
    logError('Some checks failed! Please review the issues above.');
    console.log('='.repeat(60) + '\n');
    logInfo('Remediation steps:');
    console.log('  1. Remove node-forge from dependencies');
    console.log('  2. Run: npm uninstall node-forge');
    console.log('  3. Update package-lock.json: npm install');
    console.log('  4. Consider alternatives: @peculiar/asn1-schema, asn1js, or native crypto');
    console.log('');
    process.exit(1);
  }
}

// Run the checker
try {
  main();
} catch (error) {
  logError('Script execution error:');
  console.error(error);
  process.exit(2);
}
