name: Kanban Auto Migration

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
    branches: [main, staging]
  issues:
    types: [opened, reopened, assigned]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  migrate-to-doing:
    name: Move to Doing Column
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'issues'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Move PR to Doing
        if: github.event_name == 'pull_request'
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/YYC-Cube/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Move Issue to Doing
        if: github.event_name == 'issues'
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/YYC-Cube/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add labels to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['in-progress']
            })

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ¯ æ­¤ PR å·²è‡ªåŠ¨ç§»è‡³"è¿›è¡Œä¸­"çœ‹æ¿åˆ—ã€‚CI æ£€æŸ¥æ­£åœ¨è¿è¡Œä¸­...'
            })

  validate-migration:
    name: Validate Kanban Migration
    runs-on: ubuntu-latest
    needs: migrate-to-doing
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PR is linked to issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check if PR references an issue
            const issuePattern = /#\d+|closes #\d+|fixes #\d+|resolves #\d+/i;
            const hasIssueRef = issuePattern.test(body);

            if (!hasIssueRef) {
              core.warning('æ­¤ PR æœªå…³è”ä»»ä½• Issueã€‚å»ºè®®åœ¨æè¿°ä¸­æ·»åŠ  Issue å¼•ç”¨ï¼ˆå¦‚ï¼šfixes #123ï¼‰ã€‚');
            } else {
              core.info('âœ… PR å·²å…³è” Issue');
            }

      - name: Check PR description quality
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';

            let score = 0;
            const feedback = [];

            // Check title length
            if (title.length > 10) score += 20;
            else feedback.push('æ ‡é¢˜è¿‡çŸ­ï¼Œå»ºè®®æä¾›æ›´è¯¦ç»†çš„æè¿°');

            // Check body length
            if (body.length > 50) score += 30;
            else feedback.push('æè¿°è¿‡çŸ­ï¼Œå»ºè®®æ·»åŠ æ›´å¤šå®ç°ç»†èŠ‚');

            // Check for checklist
            if (body.includes('- [')) score += 25;
            else feedback.push('å»ºè®®æ·»åŠ ä»»åŠ¡æ¸…å•è·Ÿè¸ªè¿›åº¦');

            // Check for test info
            if (body.toLowerCase().includes('test') || body.includes('æµ‹è¯•')) score += 25;
            else feedback.push('å»ºè®®è¯´æ˜æµ‹è¯•æƒ…å†µ');

            core.info(`PR è´¨é‡è¯„åˆ†: ${score}/100`);

            if (score < 50) {
              core.warning(`PR æè¿°è´¨é‡è¾ƒä½ï¼ˆ${score}/100ï¼‰ã€‚å»ºè®®æ”¹è¿›ï¼š\n${feedback.join('\n')}`);
            }

  ci-gate-check:
    name: CI Gate Status Check
    runs-on: ubuntu-latest
    needs: validate-migration
    if: github.event_name == 'pull_request'

    env:
      NODE_ENV: test
      NEXT_PUBLIC_API_BASE_URL: http://localhost:4000/api
      JWT_SECRET: test_jwt_secret_for_ci

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Run type check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build project
        run: npm run build
        timeout-minutes: 10
        continue-on-error: true

      - name: Report CI Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            const message = `${emoji} CI é—¨ç¦æ£€æŸ¥${status === 'success' ? 'é€šè¿‡' : 'å¤±è´¥'}`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
