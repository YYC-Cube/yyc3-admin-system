name: Kanban Auto-Migrate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: true

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

      - name: Unit Tests (CI)
        run: pnpm test:ci

      # 指标与文档校验可逐步增强，这里先做最小占位
      - name: Metrics & Docs Check (placeholder)
        run: |
          node -e "console.log('metrics ok')"
          test -f docs/ITERATION_BOARD_2W.md

      - name: Kanban Migrate (Backlog → Doing)
        env:
          KANBAN_ASSIGNEE: yanyu
        run: |
          node scripts/kanban-migrate.mjs

      - name: Verify Kanban Changes
        continue-on-error: true
        run: |
          echo "Verifying Kanban changes..."
          OCC_ASSIGNEE=$(grep -c '执行人：yanyu' docs/ITERATION_BOARD_2W.md || true)
          OCC_DATE=$(grep -c '起止：2025-10-31 → 2025-11-14' docs/ITERATION_BOARD_2W.md || true)
          OCC_DOING=$(grep -c '\[Doing\]' docs/ITERATION_BOARD_2W.md || true)
          {
            echo "assignee_lines=$OCC_ASSIGNEE";
            echo "date_lines=$OCC_DATE";
            echo "doing_lines=$OCC_DOING";
          } > kanban-report.txt
          cat kanban-report.txt

      - name: Upload Kanban Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kanban-migrate-report
          path: kanban-report.txt

      - name: Commit Kanban Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: Kanban auto-migrate Backlog→Doing with assignee & dates"
          file_pattern: docs/ITERATION_BOARD_2W.md
