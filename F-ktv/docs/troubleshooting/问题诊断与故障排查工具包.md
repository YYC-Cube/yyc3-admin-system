# 🔧 问题诊断与故障排查工具包

## 📋 工具包概述

本工具包为启智商家后台管理系统提供完整的问题诊断、故障排查和系统监控解决方案，支持自动化诊断、可视化报告生成、多维度健康检查等功能。

---

## 🌟 核心特性

### 🔍 全面诊断能力
- **系统健康检查**: CPU、内存、磁盘、网络状态监控
- **应用状态监控**: Node.js进程、服务响应、依赖检查
- **配置验证**: 环境变量、数据库连接、API配置验证
- **性能分析**: 响应时间、吞吐量、资源使用率分析

### 🚀 自动化工具
- **一键诊断**: 全自动系统健康检查和报告生成
- **快速检查**: 核心指标快速验证（< 30秒）
- **交互式诊断**: 图形化界面引导诊断过程
- **批量操作**: 支持多节点同时诊断

### 📊 智能报告
- **可视化图表**: 直观的问题分布和趋势分析
- **历史记录**: 诊断历史对比和趋势跟踪
- **导出功能**: 支持JSON、HTML、PDF多格式导出
- **告警机制**: 自动识别异常并发送告警通知

### 🔧 故障排查
- **根因分析**: 智能分析问题根因并提供解决方案
- **日志分析**: 自动收集和分析系统日志
- **网络诊断**: 网络连通性、延迟、丢包检测
- **安全扫描**: 安全漏洞检测和风险评估

---

## 🏗️ 系统架构

### 📁 目录结构

```
problems_and_diagnostics/
├── 📄 diagnose.sh              # 主诊断脚本
├── 📄 setup-diagnostics.sh     # 环境设置脚本
├── 📄 README.md                # 工具包说明文档
├── 📄 package.json             # 依赖管理
├── 📁 configs/                 # 配置文件目录
│   ├── 📄 diagnosis.config.js  # 诊断配置
│   ├── 📄 report.config.js     # 报告配置
│   └── 📄 alert.config.js      # 告警配置
├── 📁 scripts/                 # 脚本工具
│   ├── 📄 health-check.js      # 健康检查脚本
│   ├── 📄 performance.js       # 性能分析脚本
│   ├── 📄 security-scan.js     # 安全扫描脚本
│   ├── 📄 log-analyzer.js      # 日志分析脚本
│   └── 📄 report-generator.js  # 报告生成脚本
├── 📁 reports/                 # 报告输出目录
│   ├── 📁 daily/               # 日报告
│   ├── 📁 weekly/              # 周报告
│   └── 📁 monthly/             # 月报告
└── 📁 docs/                    # 文档目录
    ├── 📄 API.md              # API文档
    ├── 📄 CONFIGURATION.md    # 配置说明
    └── 📄 TROUBLESHOOTING.md  # 故障排查指南
```

### 🔧 核心组件

#### 1. 主诊断引擎 (diagnose.sh)
- **功能**: 统一的诊断入口，支持多种诊断模式
- **特性**: 模块化设计、配置化参数、错误处理
- **输出**: 结构化报告、状态码、日志信息

#### 2. 健康检查器 (scripts/health-check.js)
- **系统检查**: CPU、内存、磁盘、网络状态
- **应用检查**: Node.js、数据库、Redis状态
- **配置检查**: 环境变量、配置文件验证

#### 3. 性能分析器 (scripts/performance.js)
- **响应时间**: API响应时间、页面加载时间
- **资源使用**: CPU、内存、磁盘使用率
- **吞吐量**: 并发请求、QPS统计

#### 4. 安全扫描器 (scripts/security-scan.js)
- **漏洞检测**: 已知安全漏洞扫描
- **权限检查**: 文件权限、目录权限验证
- **配置安全**: 安全配置检查

#### 5. 报告生成器 (scripts/report-generator.js)
- **格式支持**: JSON、HTML、PDF多格式
- **图表生成**: 问题分布、趋势分析图表
- **历史对比**: 历史数据对比分析

---

## 🚀 快速开始

### 📥 安装与配置

#### 1. 环境要求
```bash
# 系统要求
- macOS 10.15+ / Linux Ubuntu 18.04+
- Node.js 16+
- npm 8+
- 权限要求: 执行权限、网络访问权限
```

#### 2. 初始化安装
```bash
# 进入项目目录
cd /path/to/yyc3-admin-system-2

# 进入诊断工具目录
cd problems_and_diagnostics

# 安装依赖
npm install

# 设置环境
chmod +x setup-diagnostics.sh
./setup-diagnostics.sh
```

#### 3. 全局命令配置
```bash
# 配置全局诊断命令
export PATH=$PATH:/path/to/project/bin
source ~/.bashrc

# 验证安装
diagnose --help
```

### 🏃‍♂️ 基础使用

#### 1. 系统健康检查
```bash
# 完整健康检查
./diagnose.sh --health-check

# 快速检查
./diagnose.sh --quick

# 全局命令
./bin/diagnose --health-check
```

#### 2. 性能分析
```bash
# 性能基准测试
./diagnose.sh --performance

# API响应时间测试
./diagnose.sh --api-test

# 负载测试
./diagnose.sh --load-test
```

#### 3. 安全扫描
```bash
# 基础安全扫描
./diagnose.sh --security

# 深度安全扫描
./diagnose.sh --security-deep

# 权限检查
./diagnose.sh --permissions
```

---

## 📊 详细功能说明

### 🔍 健康检查 (--health-check)

#### 检查项目
```bash
# 系统状态检查
✅ 工作目录验证
✅ 项目路径确认
✅ 配置文件存在性
✅ 关键脚本文件状态
✅ 诊断工具包完整性
✅ 临时文件清理

# 应用状态检查
✅ Node.js进程状态
✅ 数据库连接状态
✅ Redis缓存状态
✅ 文件系统权限
✅ 网络连接状态
```

#### 输出示例
```bash
=== 系统健康检查报告 ===
时间: 2025-01-18 16:30:15
状态: ✅ 正常

检查项目:
✅ 工作目录: /path/to/project
✅ 项目路径: /path/to/project/F-ktv
✅ 脚本目录: /path/to/project/problems_and_diagnostics
✅ 配置文件: diagnosis.config.js
✅ 核心脚本: diagnose.sh
✅ 诊断包状态: 完整
```

### ⚡ 快速检查 (--quick)

#### 快速验证项目
```bash
# 核心指标验证
✅ Node.js版本检查
✅ 配置文件存在性
✅ 磁盘空间检查
✅ 内存使用状态
✅ Node.js进程状态
✅ 关键文件检查
```

#### 输出示例
```bash
=== 快速系统检查 ===
完成时间: 5.2秒
状态: ✅ 健康

核心指标:
✅ Node.js: v18.17.0
✅ 配置文件: 存在
✅ 磁盘空间: 78% 可用
✅ 内存使用: 62%
✅ 进程状态: 正常运行
```

### 🐛 交互式诊断 (--interactive)

#### 图形化诊断界面
```bash
# 启动交互式诊断
./diagnose.sh --interactive

# 诊断菜单
================================
    诊断工具菜单
================================
1. 系统健康检查
2. 性能分析
3. 安全扫描
4. 日志分析
5. 故障排查
6. 报告生成
7. 历史记录
8. 配置设置
9. 帮助信息
0. 退出

请选择操作: [1-9]
```

### 📈 性能分析 (--performance)

#### 性能指标监控
```bash
# API响应时间测试
GET /api/health: 45ms
GET /api/dashboard: 120ms
POST /api/products: 200ms

# 资源使用监控
CPU使用率: 45%
内存使用: 62%
磁盘I/O: 230MB/s
网络带宽: 85%

# 并发测试结果
并发用户: 100
响应时间: 95% < 200ms
吞吐量: 850 QPS
错误率: 0.01%
```

### 🔒 安全扫描 (--security)

#### 安全检查项目
```bash
# 基础安全检查
✅ 文件权限验证
✅ 目录权限检查
✅ 环境变量检查
✅ 配置文件安全

# 漏洞扫描
✅ 依赖包漏洞检查
✅ 已知CVE扫描
✅ 安全配置检查

# 权限检查
✅ 执行权限验证
✅ 读写权限验证
✅ 敏感文件权限
```

### 📊 报告生成 (--report)

#### 报告格式与内容
```bash
# 生成综合报告
./diagnose.sh --report

# 报告内容
📋 综合健康报告
├─ 系统概览
├─ 健康检查结果
├─ 性能分析数据
├─ 安全扫描结果
├─ 问题清单
├─ 改进建议
└─ 历史趋势
```

#### 导出功能
```bash
# JSON格式导出
./diagnose.sh --report --format json

# HTML格式导出
./diagnose.sh --report --format html

# PDF格式导出
./diagnose.sh --report --format pdf
```

---

## ⚙️ 配置管理

### 📝 主配置文件 (configs/diagnosis.config.js)

```javascript
module.exports = {
  // 诊断配置
  diagnosis: {
    timeout: 30000,           // 超时时间(ms)
    retryCount: 3,            // 重试次数
    parallel: true,           // 并行执行
    modules: {
      system: true,           // 系统检查
      application: true,      // 应用检查
      performance: true,      // 性能检查
      security: true,         // 安全检查
    }
  },

  // 健康检查配置
  healthCheck: {
    intervals: {
      system: 60000,          // 系统检查间隔
      application: 30000,     // 应用检查间隔
    },
    thresholds: {
      cpu: 80,                // CPU使用率阈值
      memory: 85,             // 内存使用率阈值
      disk: 90,               // 磁盘使用率阈值
    }
  },

  // 告警配置
  alert: {
    enabled: true,
    channels: ['email', 'webhook'],
    thresholds: {
      error: 'critical',
      warning: 'warning'
    }
  }
};
```

### 🔧 环境变量配置 (.env)

```bash
# 诊断工具配置
DIAGNOSTICS_ENABLED=true
DIAGNOSTICS_LOG_LEVEL=info
DIAGNOSTICS_OUTPUT_DIR=./reports

# 告警配置
ALERT_EMAIL_ENABLED=true
ALERT_EMAIL_TO=admin@company.com
ALERT_WEBHOOK_URL=https://hooks.slack.com/services/xxx

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=yyc3_admin
DB_USER=root
DB_PASS=password

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 监控配置
MONITORING_INTERVAL=60000
METRICS_RETENTION_DAYS=30
```

---

## 🔍 高级功能

### 📊 历史趋势分析

```bash
# 查看历史报告
./diagnose.sh --history

# 趋势分析
./diagnose.sh --trend --period 7d

# 对比分析
./diagnose.sh --compare --baseline yesterday
```

### 🚨 告警与通知

#### 告警配置
```bash
# 配置告警规则
./diagnose.sh --config-alert

# 告警规则示例
{
  "rules": [
    {
      "name": "high_cpu",
      "condition": "cpu > 80",
      "level": "warning",
      "action": "send_email"
    },
    {
      "name": "critical_error",
      "condition": "error_count > 10",
      "level": "critical",
      "action": "send_webhook"
    }
  ]
}
```

### 🤖 自动化集成

#### CI/CD集成
```yaml
# .github/workflows/diagnostics.yml
name: System Diagnostics
on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # 每天2点执行

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          cd problems_and_diagnostics
          npm install
      - name: Run diagnostics
        run: |
          cd problems_and_diagnostics
          ./diagnose.sh --health-check --report --format json
      - name: Upload reports
        uses: actions/upload-artifact@v2
        with:
          name: diagnostic-reports
          path: problems_and_diagnostics/reports/
```

---

## 🔧 故障排查指南

### ❌ 常见问题与解决方案

#### 1. 诊断工具无法启动
```bash
# 问题现象
./diagnose.sh: command not found

# 解决方案
# 1. 检查文件权限
chmod +x /path/to/diagnose.sh

# 2. 检查环境变量
export PATH=$PATH:/path/to/bin

# 3. 重新初始化
./setup-diagnostics.sh
```

#### 2. 健康检查失败
```bash
# 问题现象
Health check failed: Connection timeout

# 解决方案
# 1. 检查网络连接
ping localhost

# 2. 检查端口占用
netstat -an | grep :3000

# 3. 检查防火墙设置
sudo ufw status

# 4. 重启服务
npm run restart
```

#### 3. 报告生成失败
```bash
# 问题现象
Report generation failed: Permission denied

# 解决方案
# 1. 检查目录权限
chmod 755 reports/
chown -R $USER:$USER reports/

# 2. 检查磁盘空间
df -h

# 3. 检查文件锁定
lsof reports/
```

#### 4. 性能测试超时
```bash
# 问题现象
Performance test timeout: 30000ms exceeded

# 解决方案
# 1. 调整超时配置
# 修改 configs/diagnosis.config.js
timeout: 60000

# 2. 检查系统负载
top
htop

# 3. 优化测试参数
./diagnose.sh --performance --concurrent 10
```

### 🔍 调试模式

```bash
# 启用详细日志
./diagnose.sh --health-check --verbose --debug

# 查看详细日志
tail -f logs/diagnostics.log

# 调试特定模块
./diagnose.sh --module system --debug
```

---

## 📚 最佳实践

### ✅ 日常使用建议

1. **定期健康检查**
   ```bash
   # 设置定时任务
   crontab -e
   0 */6 * * * /path/to/diagnose.sh --health-check
   ```

2. **性能基准建立**
   ```bash
   # 建立性能基线
   ./diagnose.sh --performance --baseline
   ```

3. **安全定期扫描**
   ```bash
   # 每周安全扫描
   0 2 * * 0 /path/to/diagnose.sh --security
   ```

### 🎯 优化建议

1. **监控频率优化**
   - 关键系统：每5分钟
   - 重要服务：每15分钟
   - 辅助功能：每小时

2. **告警阈值设置**
   - CPU使用率：>80%警告，>90%严重
   - 内存使用率：>85%警告，>95%严重
   - 磁盘使用率：>85%警告，>95%严重

3. **报告保留策略**
   - 日报告：保留30天
   - 周报告：保留12周
   - 月报告：保留12个月

---

## 🤝 支持与贡献

### 📞 技术支持
- 📧 邮箱: support@yyc3.com
- 📱 电话: 400-123-4567
- 💬 在线客服: https://support.yyc3.com

### 🐛 问题反馈
- GitHub Issues: https://github.com/yyc3/diagnostics/issues
- 邮件反馈: bugs@yyc3.com
- 文档反馈: docs@yyc3.com

### 💡 贡献指南
1. Fork 项目仓库
2. 创建功能分支
3. 提交代码更改
4. 创建 Pull Request
5. 代码审查与合并

---

## 📈 更新日志

### v1.0.0 (2025-01-18)
- ✅ 初始版本发布
- ✅ 基础诊断功能
- ✅ 健康检查模块
- ✅ 报告生成系统
- ✅ 全局命令配置

### 计划功能 (v1.1.0)
- [ ] Web界面诊断工具
- [ ] 实时监控仪表板
- [ ] 移动端支持
- [ ] 多语言支持
- [ ] API接口开放

---

**最后更新**: 2025-01-18  
**文档版本**: v1.0.0  
**维护团队**: 启智网络科技有限公司

© 2025 All Rights Reserved